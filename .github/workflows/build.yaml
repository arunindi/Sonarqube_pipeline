name: Build, Push Docker Image, and Analyze with SonarQube

on:
  push:
    branches:
      - main

jobs:
  build-push-and-analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Build .NET application
      run: dotnet build --configuration Release simplecs/simplecs.csproj

    - name: Publish .NET application
      run: dotnet publish --configuration Release simplecs/simplecs.csproj -o ./published

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Build Docker image
      run: docker build -t aindi123/simplecs:1.0.RELEASE -f simplecs/Dockerfile .

    - name: Log in to DockerHub
      run: docker login -u aindi123 -p dckr_pat_AhNdDxGeIDVyDVvyXsHYkmVp3fw

    - name: Push Docker image
      run: docker push aindi123/simplecs:1.0.RELEASE

    - name: Download SonarQube Scanner
      run: |
        sudo apt-get install unzip
        curl -sSLo /tmp/sonar-scanner-cli.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip
        unzip -qq /tmp/sonar-scanner-cli.zip -d /tmp

    - name: Analyze with SonarQube
      run: |
        /tmp/sonar-scanner-4.6.2.2472-linux/bin/sonar-scanner \
        -Dsonar.projectKey=Git_Action
        -Dsonar.sources=simplecs \
        -Dsonar.host.url=http://localhost:9000 \
        -Dsonar.login=sqp_fde26c2790215dba75262c1e87c9b73749242971

